<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    {% if title %}
      {{ title }} - Microblog
    {% else %}
      {{ _('Welcome to Microblog') }}
    {% endif %}
  </title>
  <!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}"> -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.min.css') }}">
</head>
<body>
  <header class="header">
    <nav class="nav">
      <div class="nav__header">
        <a class="nav__logo" href="{{ url_for('main.index') }}">Microblog</a>

        <button class="nav__toggle" type="button" aria-label="Toggle navigation">
          <span class="nav__toggle-item"></span>
        </button>
      </div>

      <div class="nav__content">
        <ul class="nav__list nav__list--left">
          <li class="nav__item">
            <a class="nav__link" href="{{ url_for('main.index') }}">{{ _('Home') }}</a>
          </li>
          <li class="nav__item">
            <a class="nav__link" href="{{ url_for('main.explore') }}">{{ _('Explore') }}</a>
          </li>
        </ul>
  
        {% if g.search_form %}
          <form class="header__search" method="get" action="{{ url_for('main.search') }}">
            {{ g.search_form.q(size=20, class='header__search-input', placeholder=g.search_form.q.label.text) }}
          </form>
        {% endif %}
  
        <ul class="nav__list nav__list--right">
          {% if current_user.is_anonymous %}
            <li class="nav__item">
              <a class="nav__link" href="{{ url_for('auth.login') }}">{{ _('Login') }}</a>
            </li>
          {% else %}
            <li class="nav__item">
              <a class="nav__link" href="{{ url_for('main.messages') }}">
                {{ _('Messages') }}
                {% set new_messages = current_user.new_messages() %}
                  <span id="message_count" class="badge" style="visibility: {% if new_message %}visible{% else %}hidden{% endif %};">
                    {{ new_messages }}
                  </span>
              </a>
            </li>
            <li class="nav__item">
              <a class="nav__link" href="{{ url_for('main.user', username=current_user.username) }}">{{ _('Profile') }}</a>
            </li>
            <li class="nav__item">
              <a class="nav__link" href="{{ url_for('auth.logout') }}">{{ _('Logout') }}</a>
            </li>
          {% endif %}
        </ul>
      </div>
    </nav>
  </header>

  <main class="main">
    <div class="main__container">
      {% if current_user.is_authenticated %}
        {% with tasks = current_user.get_tasks_in_progress() %}
          {% if tasks %}
            {% for task in tasks %}
              <div class="alert alert--success" role="alert">
                {{ task.description }}
                <span id="{{ task.id }}-progress">{{ task.get_progress() }}</span>%
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}
      {% endif %}
  
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert--info" role="alert">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </div>
  </main>

  <footer class="footer">
    <div class="footer__copyright">copyright</div>
  </footer>

  <script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
  <!-- <script src="{{ url_for('static', filename='js/bootstrap.min.js') }}"></script> -->
  {{ moment.include_moment() }}
  {{ moment.lang(g.locale) }}
  <script>
    const nav = document.querySelector('.nav');
    if (nav) {
      const navToggle = nav.querySelector('.nav__toggle');

      navToggle.addEventListener('click', () => {
        nav.classList.toggle('nav--active');
      });
    }

    // Перевод постов 
    function translate(sourceElem, destElem, sourceLang, destLang) {
      $(destElem).html('<img src="{{ url_for('static', filename='img/loading.gif') }}">');
      $.post('/translate', {
        text: $(sourceElem).text(),
        source_language: sourceLang,
        dest_language: destLang
      }).done((response) => {
        $(destElem).text(response['text'])
      }).fail(() => {
        $(destElem).text("{{ _('Error: Could not contact server.') }}");
      });
    }

    // Отображения попапа при наведении на имя пользователя
    $(() => {
      let timer = null;
      let xhr = null;
      $('.user_popup').hover(
        (event) => {
          // mouse in event handler
          const elem = $(event.currentTarget);
          timer = setTimeout(() => {
            timer = null;
            xhr = $.ajax('/user/' + elem.first().text().trim() + '/popup').done((data) => {
              xhr = null;
              elem.popover({
                trigger: 'manual',
                html: true,
                animation: false,
                container: elem,
                content: data
              }).popover('show');
                // когда новые элементы Flask-Moment добавляются через Ajax, необходимо вызвать функцию
                // flask_moment_render_all() для правельного отображения этих элементов.
              flask_moment_render_all();  
            });
          }, 1000);
        },
        (event) => {
          // mouse out event handler
          const elem = $(event.currentTarget);
          if (timer) {
            clearTimeout(timer);
            timer = null;
          } else if (xhr) {
            xhr.abort();
            xhr = null;
          } else {
            elem.popover('destroy')
          }
        }
      )
    });

    // Отображаем колочество непрочитаных сообщений
    function set_message_count(n) {
      $('#message_count').text(n);
      $('#message_count').css('visibility', n ? 'visible' : 'hidden');
    }
    // вспомогательная функция для динамического обновления хода выполнения задачи
    function set_task_progress(task_id, progress) {
      $('#' + task_id + '-progress').text(progress);
    }

    // Обновляем счетчик не прочитаных сообщений каждые 10 секунд
    {% if current_user.is_authenticated %}
      $(() => {
        let since = 0;
        setInterval(() => {
          $.ajax('{{ url_for('main.notifications') }}?since=' + since).done(
            (notifications) => {
              for (let i = 0; i < notifications.length; i++) {
                switch (notifications[i].name) {
                  case 'unread_message_count':
                    set_message_count(notifications[i].data);
                    break;
                  case 'task_progress':
                    set_task_progress(notifications[i].data.task_id, notifications[i].data.progress);
                    break;
                }
                since = notifications[i].timestamp;
              }
            }
          );
        }, 10000);
      });
    {% endif %}
  </script>
</body>
</html>